<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><!-- start: printthread -->
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml">
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<title> The internals of switch and chained else ifs and which one should you use - Printable Version</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style type="text/css">
body { font-family: Verdana, Arial, sans-serif; font-size: 13px; }
.largetext { font-family: Verdana, Arial, sans-serif; font-size: medium; font-weight: bold; }
img { max-width: 100%; height: auto; }
</style>
</head>
<body>
<table width="98%" align="center">
<tr>
<td valign="top"><a href="index-2.html"><img src="images/emerald/logo.html" alt="Burgershot" title="Burgershot" border="0" /></a></td>
</tr>
<tr>
<td>
<span class="largetext"> <a href="showthreadee38.html?tid=322">The internals of switch and chained else ifs and which one should you use</a> - Printable Version</span><br />
<br />
+- Burgershot (<em>https://www.burgershot.gg</em>)<br />
<!-- start: printthread_nav -->
+-- Forum: SA-MP (<i>https://www.burgershot.gg/forumdisplay.php?fid=3</i>)<br />
<!-- end: printthread_nav --><!-- start: printthread_nav -->
+--- Forum: Tutorials (<i>https://www.burgershot.gg/forumdisplay.php?fid=37</i>)<br />
<!-- end: printthread_nav -->
+--- Thread:  The internals of switch and chained else ifs and which one should you use (<em>/showthread.php?tid=322</em>)<br />
<br />
</td>
</tr>
<tr>
<td><br /><hr size="1" /><!-- start: printthread_post -->
<strong>The internals of switch and chained else ifs and which one should you use</strong> - <a href="member4c0d.html?action=profile&amp;uid=16">kristo</a> -  <strong>2019-04-17</strong>
<br />
<br />
<span style="color: #FF4700;" class="mycode_color"><span style="font-size: xx-large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">The internals of <span style="font-family: courier new;" class="mycode_font">switch</span> and chained <span style="font-family: courier new;" class="mycode_font">else if</span>s and which one should you use</span></span></span><br />
<br />
This tutorial takes a look into how <span style="font-family: courier new;" class="mycode_font">if</span> and <span style="font-family: courier new;" class="mycode_font">switch</span> statements work on the assembly level and helps determine, where to use a <span style="font-family: courier new;" class="mycode_font">switch</span> and where to prefer chained <span style="font-family: courier new;" class="mycode_font">else if</span>s. I decided to write this tutorial, because one of the topics I am about to address is a semi-common issue and currently there is no good place to refer to when it comes to it. In addition to that, the research I did for this tutorial helped me understand the AMX structure quite a bit more than I used to before.<br />
<br />
<span style="color: RoyalBlue;" class="mycode_color"><span style="font-size: x-large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">The internals</span></span></span><br />
<br />
I used the <span style="font-family: courier new;" class="mycode_font">-a</span> flag to generate the assembly of two simple snippets of code that perform the same task, one using <span style="font-family: courier new;" class="mycode_font">switch</span> and the other using chained <span style="font-family: courier new;" class="mycode_font">else if</span>s. I also took the time to rewrite them in a more human-readable form (using variable names instead of raw addresses, named labels instead of numbered ones prefixed with <span style="font-family: courier new;" class="mycode_font">l.</span>, etc.) and to document them. It is worth noting that while the rewritten assembly is valid, it does not currently compile due to a compiler bug related to forward jumps.<br />
<br />
<span style="color: DeepSkyBlue;" class="mycode_color"><span style="font-size: large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">Chained <span style="font-family: courier new;" class="mycode_font">else if</span>s</span></span></span><br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #007700">new&nbsp;</span><span style="color: #0000BB">val</span><span style="color: #007700">;<br /><br />if&nbsp;(</span><span style="color: #0000BB">val&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br /></span><span style="color: #007700">}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000BB">2&nbsp;</span><span style="color: #007700">&lt;=&nbsp;</span><span style="color: #0000BB">val&nbsp;</span><span style="color: #007700">&lt;=&nbsp;</span><span style="color: #0000BB">4</span><span style="color: #007700">)&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br /></span><span style="color: #007700">}&nbsp;else&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br /></span><span style="color: #007700">}&nbsp;<br /></span></code></div></div></div><br />
For the sake of simplicity I used the form <span style="font-family: courier new;" class="mycode_font">2 &lt;= val &lt;= 4</span> instead of <span style="font-family: courier new;" class="mycode_font">val &gt;= 2 &amp;&amp; val &lt;= 4</span> for the range check. If written the other way, the code would use 7 jump instructions instead of 4 and keeping track of the instructions would be more difficult. It would also be a tiny bit slower since it would have to load the value of <span style="font-family: courier new;" class="mycode_font">val</span> to the primary register one more time.<br />
<br />
When using chained <span style="font-family: courier new;" class="mycode_font">else if</span>s, the assembly contains the AMX instructions for each individual check. If the check fails, it jumps to the next check, otherwise it jumps to the end of the chain. Here is the assembly equivalent to this code:<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #007700">new&nbsp;</span><span style="color: #0000BB">val</span><span style="color: #007700">;<br /><br /><br /></span><span style="color: #FF8000">//&nbsp;if&nbsp;(val&nbsp;==&nbsp;1)<br />#emit&nbsp;LOAD.S.pri&nbsp; &nbsp; val&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;load&nbsp;the&nbsp;value&nbsp;of&nbsp;val&nbsp;to&nbsp;the&nbsp;primary&nbsp;register<br />#emit&nbsp;EQ.C.pri&nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;compare&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;primary&nbsp;register&nbsp;to&nbsp;constant&nbsp;1:&nbsp;they&nbsp;must&nbsp;be&nbsp;equal;&nbsp;store&nbsp;the&nbsp;result&nbsp;in&nbsp;the&nbsp;primary&nbsp;register<br />#emit&nbsp;JZER&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; range&nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;if&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;comparison&nbsp;is&nbsp;false,&nbsp;jump&nbsp;to&nbsp;"range"&nbsp;to&nbsp;perform&nbsp;the&nbsp;next&nbsp;check<br />//&nbsp;do&nbsp;something&nbsp;here<br />#emit&nbsp;JUMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done&nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;everything&nbsp;is&nbsp;done,&nbsp;jump&nbsp;to&nbsp;"done"<br /><br /><br />//&nbsp;else&nbsp;if&nbsp;(2&nbsp;&lt;=&nbsp;val&nbsp;&lt;=&nbsp;4)<br /></span><span style="color: #0000BB">range</span><span style="color: #007700">:<br /></span><span style="color: #FF8000">#emit&nbsp;CONST.pri&nbsp; &nbsp; &nbsp;2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;store&nbsp;the&nbsp;constant&nbsp;value&nbsp;2&nbsp;in&nbsp;the&nbsp;primary&nbsp;register<br />#emit&nbsp;LOAD.S.alt&nbsp; &nbsp; val&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;load&nbsp;the&nbsp;value&nbsp;of&nbsp;val&nbsp;to&nbsp;the&nbsp;alternate&nbsp;register<br />#emit&nbsp;SLEQ&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;compare&nbsp;the&nbsp;values&nbsp;in&nbsp;the&nbsp;registers&nbsp;to&nbsp;eachother:&nbsp;2&nbsp;(primary)&nbsp;must&nbsp;be&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;val&nbsp;(alternate);&nbsp;store&nbsp;the&nbsp;result&nbsp;in&nbsp;the&nbsp;primary&nbsp;register<br />#emit&nbsp;PUSH.pri&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;load&nbsp;the&nbsp;value&nbsp;to&nbsp;the&nbsp;primary&nbsp;register&nbsp;(the&nbsp;result&nbsp;of&nbsp;the&nbsp;comparison)&nbsp;in&nbsp;the&nbsp;stack<br />#emit&nbsp;CONST.pri&nbsp; &nbsp; &nbsp;4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;store&nbsp;the&nbsp;constant&nbsp;value&nbsp;4&nbsp;in&nbsp;the&nbsp;primary&nbsp;register<br />#emit&nbsp;SGEQ&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;compare&nbsp;the&nbsp;values&nbsp;in&nbsp;the&nbsp;registers&nbsp;to&nbsp;eachother:&nbsp;4&nbsp;(primary)&nbsp;must&nbsp;be&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;val&nbsp;(alternate);&nbsp;store&nbsp;the&nbsp;result&nbsp;in&nbsp;the&nbsp;primary&nbsp;register<br />#emit&nbsp;POP.alt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;load&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;first&nbsp;comparison&nbsp;from&nbsp;the&nbsp;stack&nbsp;to&nbsp;the&nbsp;alternate&nbsp;register<br />#emit&nbsp;AND&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;check&nbsp;if&nbsp;both&nbsp;of&nbsp;the&nbsp;comparisons&nbsp;were&nbsp;true&nbsp;by&nbsp;checking&nbsp;if&nbsp;both&nbsp;registers&nbsp;contain&nbsp;a&nbsp;non-zero&nbsp;value<br />#emit&nbsp;JZER&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otherwise&nbsp; &nbsp;//&nbsp;if&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;comparison&nbsp;is&nbsp;false,&nbsp;jump&nbsp;to&nbsp;"otherwise"<br />//&nbsp;do&nbsp;something&nbsp;here<br />#emit&nbsp;JUMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done&nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;everything&nbsp;is&nbsp;done,&nbsp;jump&nbsp;to&nbsp;"done"<br /><br />//&nbsp;else<br /></span><span style="color: #0000BB">otherwise</span><span style="color: #007700">:<br /></span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br />//&nbsp;no&nbsp;jump&nbsp;needed&nbsp;since&nbsp;"done"&nbsp;is&nbsp;just&nbsp;after&nbsp;this&nbsp;code<br /><br /><br /></span><span style="color: #0000BB">done</span><span style="color: #007700">:&nbsp;<br /></span></code></div></div></div><br />
If the value of <span style="font-family: courier new;" class="mycode_font">val</span> is 1, the code uses four instructions:<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #0000BB">LOAD</span><span style="color: #007700">.</span><span style="color: #0000BB">S</span><span style="color: #007700">.</span><span style="color: #0000BB">pri &nbsp;val<br />EQ</span><span style="color: #007700">.</span><span style="color: #0000BB">C</span><span style="color: #007700">.</span><span style="color: #0000BB">pri &nbsp; &nbsp;1<br />JZER &nbsp; &nbsp; &nbsp; &nbsp;range&nbsp;</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">the&nbsp;jump&nbsp;does&nbsp;not&nbsp;happen</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">but&nbsp;the&nbsp;instruction&nbsp;is&nbsp;still&nbsp;used<br />JUMP &nbsp; &nbsp; &nbsp; &nbsp;done&nbsp;<br /></span></code></div></div></div><br />
If the value of <span style="font-family: courier new;" class="mycode_font">val</span> is 2, 3 or 4, the code uses 13 instructions:<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #0000BB">LOAD</span><span style="color: #007700">.</span><span style="color: #0000BB">S</span><span style="color: #007700">.</span><span style="color: #0000BB">pri &nbsp;val<br />EQ</span><span style="color: #007700">.</span><span style="color: #0000BB">C</span><span style="color: #007700">.</span><span style="color: #0000BB">pri &nbsp; &nbsp;1<br />JZER &nbsp; &nbsp; &nbsp; &nbsp;range<br /></span><span style="color: #007700">CONST.</span><span style="color: #0000BB">pri &nbsp; 2<br />LOAD</span><span style="color: #007700">.</span><span style="color: #0000BB">S</span><span style="color: #007700">.</span><span style="color: #0000BB">alt &nbsp;val<br />SLEQ<br />PUSH</span><span style="color: #007700">.</span><span style="color: #0000BB">pri<br /></span><span style="color: #007700">CONST.</span><span style="color: #0000BB">pri &nbsp; 4<br />SGEQ<br />POP</span><span style="color: #007700">.</span><span style="color: #0000BB">alt<br /></span><span style="color: #007700">AND<br /></span><span style="color: #0000BB">JZER &nbsp; &nbsp; &nbsp; &nbsp;otherwise&nbsp;</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">the&nbsp;jump&nbsp;does&nbsp;not&nbsp;happen</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">but&nbsp;the&nbsp;instruction&nbsp;is&nbsp;still&nbsp;used<br />JUMP &nbsp; &nbsp; &nbsp; &nbsp;done&nbsp;<br /></span></code></div></div></div><br />
If the value is not matched by any of the previous checks, the code uses 12 instructions:<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #0000BB">LOAD</span><span style="color: #007700">.</span><span style="color: #0000BB">S</span><span style="color: #007700">.</span><span style="color: #0000BB">pri &nbsp;val<br />EQ</span><span style="color: #007700">.</span><span style="color: #0000BB">C</span><span style="color: #007700">.</span><span style="color: #0000BB">pri &nbsp; &nbsp;1<br />JZER &nbsp; &nbsp; &nbsp; &nbsp;range<br /></span><span style="color: #007700">CONST.</span><span style="color: #0000BB">pri &nbsp; 2<br />LOAD</span><span style="color: #007700">.</span><span style="color: #0000BB">S</span><span style="color: #007700">.</span><span style="color: #0000BB">alt &nbsp;val<br />SLEQ<br />PUSH</span><span style="color: #007700">.</span><span style="color: #0000BB">pri<br /></span><span style="color: #007700">CONST.</span><span style="color: #0000BB">pri &nbsp; 4<br />SGEQ<br />POP</span><span style="color: #007700">.</span><span style="color: #0000BB">alt<br /></span><span style="color: #007700">AND<br /></span><span style="color: #0000BB">JZER &nbsp; &nbsp; &nbsp; &nbsp;otherwise&nbsp;<br /></span></code></div></div></div><br />
The longer your chain is and the more failed checks there are, the more instructions the code uses. Each failed single value check adds 3 instructions and each failed range check adds 9 instructions.<br />
<br />
<span style="color: DeepSkyBlue;" class="mycode_color"><span style="font-size: large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b"><span style="font-family: courier new;" class="mycode_font">switch</span></span></span></span><br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #007700">new&nbsp;</span><span style="color: #0000BB">val</span><span style="color: #007700">;<br /><br />switch&nbsp;(</span><span style="color: #0000BB">val</span><span style="color: #007700">)&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; case&nbsp;1</span><span style="color: #007700">:&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; &nbsp; &nbsp; </span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br /><br /></span><span style="color: #0000BB"> &nbsp; case&nbsp;2&nbsp;</span><span style="color: #007700">..&nbsp;</span><span style="color: #0000BB">4</span><span style="color: #007700">:&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; &nbsp; &nbsp; </span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br /><br /></span><span style="color: #0000BB"> &nbsp; default</span><span style="color: #007700">:&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; &nbsp; &nbsp; </span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br />}&nbsp;<br /></span></code></div></div></div><br />
When using <span style="font-family: courier new;" class="mycode_font">switch</span>, the compiler generates a case table that contains the value and jump address for every single case, including the default case. Here is the assembly equivalent to this code:<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #007700">new&nbsp;</span><span style="color: #0000BB">val</span><span style="color: #007700">;<br /><br /><br /></span><span style="color: #FF8000">#emit&nbsp;LOAD.S.pri&nbsp; &nbsp; val&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;load&nbsp;the&nbsp;value&nbsp;of&nbsp;val&nbsp;to&nbsp;the&nbsp;primary&nbsp;register<br />#emit&nbsp;SWITCH&nbsp; &nbsp; &nbsp; &nbsp; casetable&nbsp; &nbsp;//&nbsp;jump&nbsp;to&nbsp;the&nbsp;case&nbsp;table<br /><br />//&nbsp;case&nbsp;1:<br /></span><span style="color: #0000BB">single</span><span style="color: #007700">:<br /></span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br />#emit&nbsp;JUMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done&nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;everything&nbsp;is&nbsp;done,&nbsp;jump&nbsp;to&nbsp;"done"<br /><br /><br /></span><span style="color: #0000BB">range</span><span style="color: #007700">:<br /></span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br />#emit&nbsp;JUMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done&nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;everything&nbsp;is&nbsp;done,&nbsp;jump&nbsp;to&nbsp;"done"<br /><br /><br /></span><span style="color: #0000BB">otherwise</span><span style="color: #007700">:<br /></span><span style="color: #FF8000">//&nbsp;do&nbsp;something&nbsp;here<br />#emit&nbsp;JUMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done&nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;everything&nbsp;is&nbsp;done,&nbsp;jump&nbsp;to&nbsp;"done"<br /><br /><br /></span><span style="color: #0000BB">casetable</span><span style="color: #007700">:<br /></span><span style="color: #FF8000">#emit&nbsp;CASETBL<br />//&nbsp;default:<br />#emit&nbsp;CASE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4&nbsp;otherwise&nbsp;//&nbsp;the&nbsp;amount&nbsp;of&nbsp;case&nbsp;table&nbsp;items;&nbsp;the&nbsp;jump&nbsp;address&nbsp;of&nbsp;"default"<br />//&nbsp;case&nbsp;1:<br />#emit&nbsp;CASE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp;single&nbsp; &nbsp; //&nbsp;the&nbsp;value&nbsp;and&nbsp;jump&nbsp;address&nbsp;of&nbsp;the&nbsp;case<br />//&nbsp;case&nbsp;2&nbsp;..&nbsp;4:<br />#emit&nbsp;CASE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2&nbsp;range<br />#emit&nbsp;CASE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3&nbsp;range<br />#emit&nbsp;CASE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4&nbsp;range<br /><br /><br /></span><span style="color: #0000BB">done</span><span style="color: #007700">:&nbsp;<br /></span></code></div></div></div><br />
Whatever the value of <span style="font-family: courier new;" class="mycode_font">val</span> is 1, the code always uses just three instructions:<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #0000BB">LOAD</span><span style="color: #007700">.</span><span style="color: #0000BB">S</span><span style="color: #007700">.</span><span style="color: #0000BB">pri &nbsp;val<br />SWITCH &nbsp; &nbsp; &nbsp;casetable<br />JUMP &nbsp; &nbsp; &nbsp; &nbsp;done&nbsp;<br /></span></code></div></div></div><br />
The <span style="font-family: courier new;" class="mycode_font">SWITCH</span> instruction jumps to the case table, performs a linear search on the cases and jumps to the correct one. If the search does not find a matching case, it jumps to the default case instead. It is similar to the behaviour of chained <span style="font-family: courier new;" class="mycode_font">else if</span>s, but since it is done in native code instead of using AMX instructions, the performance is a lot better.<br />
<br />
<span style="color: RoyalBlue;" class="mycode_color"><span style="font-size: x-large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">When NOT to use <span style="font-family: courier new;" class="mycode_font">switch</span>?</span></span></span><br />
<br />
<span style="color: DeepSkyBlue;" class="mycode_color"><span style="font-size: large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">Large ranges</span></span></span><br />
<br />
As seen before, case tables can only use single values as cases, which means that if you use a range of 10000 elements in your <span style="font-family: courier new;" class="mycode_font">switch</span>, the compiler will have to write 10000 entries to the case table and the runtime will have to search through 10000 entries. Using the following benchmarking script I determined that the runtime performance of a case table becomes worse than the one of a <span style="font-weight: bold;" class="mycode_b">single</span> <span style="font-family: courier new;" class="mycode_font">a &lt;= x &lt;= b</span> check at around 30 entries.<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #FF8000">#define&nbsp;MAX&nbsp;30<br />#define&nbsp;ITERATIONS&nbsp;1000000<br /><br /></span><span style="color: #007700">new&nbsp;</span><span style="color: #0000BB">tick&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">GetTickCount</span><span style="color: #007700">();<br /><br />for&nbsp;(new&nbsp;</span><span style="color: #0000BB">i</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">i&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">ITERATIONS</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">i</span><span style="color: #007700">++)&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; switch&nbsp;</span><span style="color: #007700">((</span><span style="color: #0000BB">i&nbsp;</span><span style="color: #007700">%&nbsp;</span><span style="color: #0000BB">MAX</span><span style="color: #007700">)&nbsp;+&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; &nbsp; &nbsp; case&nbsp;1&nbsp;</span><span style="color: #007700">..&nbsp;</span><span style="color: #0000BB">MAX</span><span style="color: #007700">:&nbsp;{}<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br />}<br /><br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"switch:&nbsp;%i"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">GetTickCount</span><span style="color: #007700">()&nbsp;-&nbsp;</span><span style="color: #0000BB">tick</span><span style="color: #007700">);<br /><br /><br /></span><span style="color: #0000BB">tick&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">GetTickCount</span><span style="color: #007700">();<br /><br />for&nbsp;(new&nbsp;</span><span style="color: #0000BB">i</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">i&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">ITERATIONS</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">i</span><span style="color: #007700">++)&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; if&nbsp;</span><span style="color: #007700">(</span><span style="color: #0000BB">1&nbsp;</span><span style="color: #007700">&lt;=&nbsp;(</span><span style="color: #0000BB">i&nbsp;</span><span style="color: #007700">%&nbsp;</span><span style="color: #0000BB">MAX</span><span style="color: #007700">)&nbsp;+&nbsp;</span><span style="color: #0000BB">1&nbsp;</span><span style="color: #007700">&lt;=&nbsp;</span><span style="color: #0000BB">MAX</span><span style="color: #007700">)&nbsp;{}<br />}<br /><br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"if:&nbsp;%i"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">GetTickCount</span><span style="color: #007700">()&nbsp;-&nbsp;</span><span style="color: #0000BB">tick</span><span style="color: #007700">);&nbsp;<br /></span></code></div></div></div><br />
However, runtime performance is not the biggest issue. As seen from <a href="https://forum.sa-mp.com/showthread.php?t=660273" target="_blank" rel="noopener" class="mycode_url">this forum topic</a>, the amount of time it takes for the compiler to generate large case tables can be so long that it seems for the user that the compiler has ran into an infinite loop. Even ranges small enough to only have a small impact on the compilation time (for example, 1000 elements) can eventually make the compilation process painful if the delays stack up.<br />
<br />
<span style="color: DeepSkyBlue;" class="mycode_color"><span style="font-size: large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">Floating point values</span></span></span><br />
<br />
When using <span style="font-family: courier new;" class="mycode_font">switch</span> with floating point values, the case table must also contain every single value within the range. The step between two cases grows as the values grow, but it starts at the smallest possible floating point value in the IEEE754 specification, which is <span style="font-family: courier new;" class="mycode_font">1.4E-45</span>. This means that each entry differs from the previous and next one by just <span style="font-family: courier new;" class="mycode_font">0.0000000000000000000000000000000000000000000014</span>.<br />
<br />
Some examples of ranges with the respective amounts of case table elements:<br />
<br />
<div class="codeblock"><div class="title">Code:</div><div class="body" dir="ltr"><code>|                       Range                       | Amount of entries |<br />
|---------------------------------------------------|-------------------|<br />
| 0.0 .. 0.0000000000000000000000000000000000000001 |       71363       |<br />
|                    1.0 .. 1.01                    |       83887       |<br />
|                   10.0 .. 10.1                    |       104859      |<br />
|                  100.0 .. 101.0                   |       131073      |<br />
|                 1000.0 .. 1010.0                  |       163841      |<br />
|                10000.0 .. 10100.0                 |       102401      |<br />
|               100000.0 .. 101000.0                |       128001      |</code></div></div><br />
This test should be enough to show that using <span style="font-family: courier new;" class="mycode_font">switch</span> with floating point values relevant in the context of SA-MP (coordinates, health, etc.) is completely unreasonable.<br />
<br />
<span style="color: RoyalBlue;" class="mycode_color"><span style="font-size: x-large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">When to use <span style="font-family: courier new;" class="mycode_font">switch</span>?</span></span></span><br />
<br />
I would say that everywhere where there are chains of comparisons against constant values. I have seen people saying that <span style="font-family: courier new;" class="mycode_font">switch</span> is faster no matter what and using a <span style="font-family: courier new;" class="mycode_font">switch</span> with two cases is much faster than an <span style="font-family: courier new;" class="mycode_font">if</span>-<span style="font-family: courier new;" class="mycode_font">else</span>. However, their runtime performance is about the same and where an <span style="font-family: courier new;" class="mycode_font">if</span> and an <span style="font-family: courier new;" class="mycode_font">else</span> make more sense, they should be used instead.<br />
<br />
<span style="color: RoyalBlue;" class="mycode_color"><span style="font-size: x-large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">Tips and tricks</span></span></span><br />
<br />
<span style="color: DeepSkyBlue;" class="mycode_color"><span style="font-size: large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">Using <span style="font-family: courier new;" class="mycode_font">switch</span> with <span style="font-family: courier new;" class="mycode_font">floatcmp</span> to compare floating point values</span></span></span><br />
<br />
Comparison operators for variables with the <span style="font-family: courier new;" class="mycode_font">Float</span> tag are overloaded to use the <span style="font-family: courier new;" class="mycode_font">floatcmp</span> native instead of comparing them with AMX instructions. When comparing floating point values to eachother and having different outcomes depending of if one of the values is larger than the other or they are equal, you can save a <span style="font-family: courier new;" class="mycode_font">floatcmp</span> call by comparing them using <span style="font-family: courier new;" class="mycode_font">switch</span> instead. <span style="font-family: courier new;" class="mycode_font">floatcmp</span> returns <span style="font-family: courier new;" class="mycode_font">0</span> if the values are equal, <span style="font-family: courier new;" class="mycode_font">1</span> if the first value is larger and <span style="font-family: courier new;" class="mycode_font">-1</span> if the second value is larger, so the following snippets of code are equivalent, but the second one performs better:<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">a&nbsp;</span><span style="color: #007700">&gt;&nbsp;</span><span style="color: #0000BB">b</span><span style="color: #007700">)&nbsp;{&nbsp;</span><span style="color: #FF8000">//&nbsp;floatcmp&nbsp;called&nbsp;implicitly<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #FF8000">//&nbsp;a&nbsp;is&nbsp;larger&nbsp;than&nbsp;b<br /></span><span style="color: #007700">}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000BB">a&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">b</span><span style="color: #007700">)&nbsp;{&nbsp;</span><span style="color: #FF8000">//&nbsp;floatcmp&nbsp;called&nbsp;implicitly<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #FF8000">//&nbsp;a&nbsp;is&nbsp;smaller&nbsp;than&nbsp;b<br /></span><span style="color: #007700">}&nbsp;else&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #FF8000">//&nbsp;a&nbsp;and&nbsp;b&nbsp;are&nbsp;equal<br /></span><span style="color: #007700">}&nbsp;<br /></span></code></div></div></div><br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #007700">switch&nbsp;(</span><span style="color: #0000BB">floatcmp</span><span style="color: #007700">(</span><span style="color: #0000BB">a</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">b</span><span style="color: #007700">))&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; case&nbsp;1</span><span style="color: #007700">:&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; &nbsp; &nbsp; </span><span style="color: #FF8000">//&nbsp;a&nbsp;is&nbsp;larger&nbsp;than&nbsp;b<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br /><br /></span><span style="color: #0000BB"> &nbsp; case&nbsp;</span><span style="color: #007700">-</span><span style="color: #0000BB">1</span><span style="color: #007700">:&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; &nbsp; &nbsp; </span><span style="color: #FF8000">//&nbsp;a&nbsp;is&nbsp;smaller&nbsp;than&nbsp;b<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br /><br /></span><span style="color: #0000BB"> &nbsp; case&nbsp;0</span><span style="color: #007700">:&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; &nbsp; &nbsp; </span><span style="color: #FF8000">//&nbsp;a&nbsp;and&nbsp;b&nbsp;are&nbsp;equal<br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br />}&nbsp;<br /></span></code></div></div></div><br />
<span style="color: DeepSkyBlue;" class="mycode_color"><span style="font-size: large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">Using <span style="font-family: courier new;" class="mycode_font">switch</span> to compare strings</span></span></span><br />
<br />
Comparing strings with <span style="font-family: courier new;" class="mycode_font">strcmp</span> has been notorious being both slow and tedious for a long time. Although most of that bad reputation came when ZCMD became the goto command processor and <span style="font-family: courier new;" class="mycode_font">strcmp</span> is still very useful elsewhere, there is a grain of truth in every joke. When comparing a string to a long chain of other strings, comparing their hashes would be more efficient and also convenient due to the ability to use <span style="font-family: courier new;" class="mycode_font">switch</span>, because the hashes are in the form of integers. The PAWN language does not support such thing natively, but y_stringhash from YSI does just the job. According to <a href="https://forum.sa-mp.com/showpost.php?p=3901202&amp;postcount=4" target="_blank" rel="noopener" class="mycode_url">Y_Less’ tests</a>, comparing strings using hashes becomes more efficient than using <span style="font-family: courier new;" class="mycode_font">strcmp</span> at around 10 comparisons. More information about y_stringhash and its usage can be found from <a href="https://forum.sa-mp.com/showthread.php?t=571305" target="_blank" rel="noopener" class="mycode_url">this topic</a>.<br />
<br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">strcmp</span><span style="color: #007700">(</span><span style="color: #0000BB">number</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"one"</span><span style="color: #007700">))&nbsp;{<br /><br />}&nbsp;else&nbsp;if&nbsp;(!</span><span style="color: #0000BB">strcmp</span><span style="color: #007700">(</span><span style="color: #0000BB">number</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"two"</span><span style="color: #007700">)&nbsp;||&nbsp;!</span><span style="color: #0000BB">strcmp</span><span style="color: #007700">(</span><span style="color: #0000BB">number</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"three"</span><span style="color: #007700">))&nbsp;{<br /><br />}&nbsp;else&nbsp;{<br /><br />}&nbsp;<br /></span></code></div></div></div><br />
<div class="codeblock phpcodeblock"><div class="title">PHP Code:</div><div class="body"><div dir="ltr"><code><span style="color: #007700">switch&nbsp;(</span><span style="color: #0000BB">YHash</span><span style="color: #007700">(</span><span style="color: #0000BB">number</span><span style="color: #007700">))&nbsp;{<br /></span><span style="color: #0000BB"> &nbsp; case&nbsp;_H</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">one</span><span style="color: #007700">&gt;:&nbsp;{<br /><br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br /><br /></span><span style="color: #0000BB"> &nbsp; case&nbsp;_H</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">two</span><span style="color: #007700">&gt;,&nbsp;</span><span style="color: #0000BB">_H</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">three</span><span style="color: #007700">&gt;:&nbsp;{<br /><br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br /><br /></span><span style="color: #0000BB"> &nbsp; default</span><span style="color: #007700">:&nbsp;{<br /><br /></span><span style="color: #0000BB"> &nbsp; </span><span style="color: #007700">}<br />}&nbsp;<br /></span></code></div></div></div><br />
<span style="color: RoyalBlue;" class="mycode_color"><span style="font-size: x-large;" class="mycode_size"><span style="font-weight: bold;" class="mycode_b">Credits</span></span></span><br />
<ul class="mycode_list"><li>Yashas for the excellent <a href="https://github.com/YashasSamaga/AMX-Assembly-Docs" target="_blank" rel="noopener" class="mycode_url">AMX Assembly documentation</a>.<br />
</li>
<li>Y_Less for reviewing the tutorial prior to me publishing it.<br />
</li>
<li>Users of the SA-MP Discord for productive conversations on this topic.<br />
</li>
</ul>

<br />
<br />
<hr size="1" />
<!-- end: printthread_post --></td>
</tr>
</table>
</body>
</html>
<!-- end: printthread -->